<script type="module">
  // --- Game State Variables ---
  let myTeamScore = 0;
  let rivalTeamScore = 0;
  const STAT_TYPES = ['shots', 'rebounds', 'assists', 'points'];
  let activeStat = null; // MODIFIED: No default active stat
  let players = []; // Array to hold player objects
  let activePlayerId = null; // New variable to track the currently selected player

  // --- Message Box Utility ---
  const messageBoxModal = document.getElementById('message-box-modal');
  const messageBoxTitle = document.getElementById('message-box-title');
  const messageBoxMessage = document.getElementById('message-box-message');
  const messageBoxConfirmBtn = document.getElementById('message-box-confirm-btn');
  const messageBoxCancelBtn = document.getElementById('message-box-cancel-btn');
  const messageBoxOkBtn = document.getElementById('message-box-ok-btn');

  function showMessageBox(title, message, type = 'alert', onConfirm = null, onCancel = null) {
    messageBoxTitle.textContent = title;
    messageBoxMessage.textContent = message;

    messageBoxConfirmBtn.classList.add('hidden');
    messageBoxCancelBtn.classList.add('hidden');
    messageBoxOkBtn.classList.add('hidden');

    // Remove previous event listeners
    messageBoxConfirmBtn.onclick = null;
    messageBoxCancelBtn.onclick = null;
    messageBoxOkBtn.onclick = null;

    if (type === 'confirm') {
      messageBoxConfirmBtn.classList.remove('hidden');
      messageBoxCancelBtn.classList.remove('hidden');
      messageBoxConfirmBtn.onclick = () => {
        messageBoxModal.classList.add('hidden');
        if (onConfirm) onConfirm();
        // Animate out
        messageBoxModal.querySelector('.modal-content').classList.remove('scale-100', 'opacity-100');
        messageBoxModal.querySelector('.modal-content').classList.add('scale-95', 'opacity-0');
      };
      messageBoxCancelBtn.onclick = () => {
        messageBoxModal.classList.add('hidden');
        if (onCancel) onCancel();
        // Animate out
        messageBoxModal.querySelector('.modal-content').classList.remove('scale-100', 'opacity-100');
        messageBoxModal.querySelector('.modal-content').classList.add('scale-95', 'opacity-0');
      };
    } else { // 'alert'
      messageBoxOkBtn.classList.remove('hidden');
      messageBoxOkBtn.onclick = () => {
        messageBoxModal.classList.add('hidden');
        // Animate out
        messageBoxModal.querySelector('.modal-content').classList.remove('scale-100', 'opacity-100');
        messageBoxModal.querySelector('.modal-content').classList.add('scale-95', 'opacity-0');
      };
    }
    messageBoxModal.classList.remove('hidden');
    // Animate in
    setTimeout(() => {
      messageBoxModal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0');
      messageBoxModal.querySelector('.modal-content').classList.add('scale-100', 'opacity-100');
    }, 50);
  }

  // --- Game State Management (Local) ---
  function initialSetup() {
    // Initialize players if they don't exist
    if (players.length === 0) {
      for (let i = 1; i <= 10; i++) {
        players.push({
          id: `player${i}`,
          name: `Player ${i}`,
          locked: false,
          stats: { shots: 0, rebounds: 0, assists: 0, points: 0 }
        });
      }
    }
    updateUI();
  }

  function updateUI() {
    document.getElementById('my-team-score').textContent = myTeamScore;
    document.getElementById('rival-team-score').textContent = rivalTeamScore;

    // MODIFIED: Show/hide stat buttons based on activePlayerId
    const statButtonsContainer = document.getElementById('stat-buttons');
    if (activePlayerId) {
      statButtonsContainer.classList.remove('hidden');
    } else {
      statButtonsContainer.classList.add('hidden');
    }

    // Render player buttons
    const playersGrid = document.getElementById('players-grid');
    playersGrid.innerHTML = ''; // Clear existing buttons

    players.forEach(player => {
      const playerButton = document.createElement('button');
      playerButton.id = `player-btn-${player.id}`;
      playerButton.className = `btn-player w-full`;
      if (player.locked) {
        playerButton.classList.add('player-button-locked');
      }
      if (player.id === activePlayerId) {
        playerButton.classList.add('player-active');
      }

      playerButton.innerHTML = `
        <span class="player-name text-sm font-semibold">${player.name}</span>
        <div class="player-stats text-xs text-gray-600 mt-0.5">
          <span class="shots-stat">S: ${player.stats.shots}</span> |
          <span class="rebounds-stat">R: ${player.stats.rebounds}</span> |
          <span class="assists-stat">A: ${player.stats.assists}</span> |
          <span class="points-stat">P: ${player.stats.points}</span>
        </div>
      `;

      // MODIFIED: Use a click listener to select a player
      playerButton.addEventListener('click', () => {
        if (player.locked) {
            showMessageBox('Locked Player', 'This player is locked and cannot be selected to add stats.', 'alert');
            return;
        }
        selectPlayer(player.id);
      });

      playersGrid.appendChild(playerButton);
    });

    // MODIFIED: Update stat buttons styling
    STAT_TYPES.forEach(stat => {
      const button = document.getElementById(`${stat}-btn`);
      if (button) {
        if (stat === activeStat) {
          button.classList.add('stat-active');
          button.classList.remove('stat-inactive');
          button.classList.remove('bg-indigo-100', 'text-indigo-700', 'hover:bg-indigo-200');
          button.classList.add('bg-indigo-600', 'text-white', 'hover:bg-indigo-700');
        } else {
          button.classList.remove('stat-active');
          button.classList.add('stat-inactive');
          button.classList.remove('bg-indigo-600', 'text-white', 'hover:bg-indigo-700');
          button.classList.add('bg-indigo-100', 'text-indigo-700', 'hover:bg-indigo-200');
        }
      }
    });
  }

  // MODIFIED: New function to handle player selection
  function selectPlayer(playerId) {
      activePlayerId = playerId;
      // You can set a default activeStat here if you want a stat to be pre-selected
      // activeStat = 'shots'; 
      saveGameData();
      updateUI();
  }

  // MODIFIED: This function is now for incrementing a stat for the active player
  function incrementPlayerStat(statType) {
    if (!activePlayerId) {
      showMessageBox('No Player Selected', 'Please select a player first.', 'alert');
      return;
    }

    const playerIndex = players.findIndex(p => p.id === activePlayerId);
    if (playerIndex !== -1) {
      // Check if the active stat is 'points'
      if (statType === 'points') {
        players[playerIndex].stats[statType] += 2; // Increment player's points by 2
        myTeamScore += 2; // Increment team score by 2
      } else {
        players[playerIndex].stats[statType]++; // Increment other stats by 1
      }

      // MODIFIED: After adding a stat, deselect the player
      activePlayerId = null;
      activeStat = null;
      
      saveGameData();
      updateUI();
    } else {
      console.error(`Player with ID ${activePlayerId} not found.`);
    }
  }

  function incrementRivalPoints() {
    rivalTeamScore += 2;
    saveGameData();
    updateUI();
  }

  // --- Local Storage Operations ---
  const LOCAL_STORAGE_KEY = 'basketballGameData';

  function saveGameData() {
    const dataToSave = {
      myTeamScore: myTeamScore,
      rivalTeamScore: rivalTeamScore,
      players: players.map(player => ({
        ...player,
        stats: { ...player.stats }
      })),
      activeStat: activeStat,
      activePlayerId: activePlayerId
    };
    try {
      localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
    } catch (e) {
      console.error("Error saving game data to Local Storage: ", e);
      showMessageBox('Save Error', `Failed to save game data locally: ${e.message}`, 'alert');
    }
  }

  function loadGameData() {
    try {
      const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
      if (savedData) {
        const data = JSON.parse(savedData);
        myTeamScore = data.myTeamScore || 0;
        rivalTeamScore = data.rivalTeamScore || 0;
        players = data.players || [];
        activeStat = data.activeStat || null;
        activePlayerId = data.activePlayerId || null;
        initialSetup();
      } else {
        initialSetup();
        saveGameData();
      }
    } catch (e) {
      console.error("Error loading game data from Local Storage: ", e);
      showMessageBox('Load Error', `Failed to load game data locally: ${e.message}`, 'alert');
      initialSetup();
    }
  }

  // --- Global Edit Players Modal Logic ---
  const editAllPlayersModal = document.getElementById('edit-all-players-modal');
  const allPlayersEditList = document.getElementById('all-players-edit-list');
  const saveAllPlayersBtn = document.getElementById('save-all-players-btn');
  const cancelAllEditBtn = document.getElementById('cancel-all-edit-btn');
  const editAllPlayersBtn = document.getElementById('edit-all-players-btn');

  editAllPlayersBtn.addEventListener('click', openEditAllPlayersModal);

  function openEditAllPlayersModal() {
    allPlayersEditList.innerHTML = '';

    players.forEach(player => {
      const playerEditDiv = document.createElement('div');
      playerEditDiv.className = 'flex items-center space-x-2 p-2 bg-gray-50 rounded-md';
      playerEditDiv.dataset.playerId = player.id;

      playerEditDiv.innerHTML = `
        <input type="text" value="${player.name}" placeholder="Player Name" class="flex-grow p-1 border border-gray-300 rounded-md text-gray-800 text-sm">
        <button class="toggle-lock-btn px-2 py-1 rounded-md bg-gray-200 text-gray-700 text-xs font-semibold">
          ${player.locked ? 'Unlock Name' : 'Lock Name'}
        </button>
      `;
      allPlayersEditList.appendChild(playerEditDiv);

      const toggleLockBtn = playerEditDiv.querySelector('.toggle-lock-btn');
      toggleLockBtn.addEventListener('click', () => {
        const currentLockedStatus = players.find(p => p.id === player.id).locked;
        players.find(p => p.id === player.id).locked = !currentLockedStatus;
        toggleLockBtn.textContent = !currentLockedStatus ? 'Unlock Name' : 'Lock Name';
      });
    });

    editAllPlayersModal.classList.remove('hidden');
    setTimeout(() => {
      editAllPlayersModal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0');
      editAllPlayersModal.querySelector('.modal-content').classList.add('scale-100', 'opacity-100');
    }, 50);
  }

  saveAllPlayersBtn.addEventListener('click', () => {
    const playerEditDivs = allPlayersEditList.querySelectorAll('[data-player-id]');
    playerEditDivs.forEach(div => {
      const playerId = div.dataset.playerId;
      const newName = div.querySelector('input[type="text"]').value.trim();
      const playerIndex = players.findIndex(p => p.id === playerId);
      if (playerIndex !== -1) {
        players[playerIndex].name = newName || `Player ${playerIndex + 1}`;
      }
    });
    saveGameData();
    updateUI();
    closeEditAllPlayersModal();
  });

  cancelAllEditBtn.addEventListener('click', () => {
    closeEditAllPlayersModal();
  });

  function closeEditAllPlayersModal() {
    editAllPlayersModal.classList.add('hidden');
    editAllPlayersModal.querySelector('.modal-content').classList.remove('scale-100', 'opacity-100');
    editAllPlayersModal.querySelector('.modal-content').classList.add('scale-95', 'opacity-0');
  }


  // --- Report Modal Logic ---
  const reportModal = document.getElementById('report-modal');
  const reportOutput = document.getElementById('report-output');
  const generateReportBtn = document.getElementById('generate-report-btn');
  const copyReportBtn = document.getElementById('copy-report-btn');
  const closeReportBtn = document.getElementById('close-report-btn');

  generateReportBtn.addEventListener('click', () => {
    const reportContent = generateReport();
    reportOutput.textContent = reportContent;
    reportModal.classList.remove('hidden');
    setTimeout(() => {
      reportModal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0');
      reportModal.querySelector('.modal-content').classList.add('scale-100', 'opacity-100');
    }, 50);
  });

  copyReportBtn.addEventListener('click', () => {
    if (reportOutput) {
      const range = document.createRange();
      range.selectNodeContents(reportOutput);
      const selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(range);
      try {
        document.execCommand('copy');
        showMessageBox('Copied!', 'Report copied to clipboard.', 'alert');
      } catch (err) {
        console.error('Failed to copy text: ', err);
        showMessageBox('Copy Error', 'Failed to copy report to clipboard. Please try manually selecting and copying the text.', 'alert');
      }
      selection.removeAllRanges();
    }
  });


  closeReportBtn.addEventListener('click', () => {
    reportModal.classList.add('hidden');
    reportModal.querySelector('.modal-content').classList.remove('scale-100', 'opacity-100');
    reportModal.querySelector('.modal-content').classList.add('scale-95', 'opacity-0');
  });

  function generateReport() {
    let report = `Basketball Game Report\n`;
    report += `-------------------------\n`;
    report += `My Team Score: ${myTeamScore}\n`;
    report += `Rival Team Score: ${rivalTeamScore}\n\n`;
    report += `Player Statistics:\n`;
    players.forEach(player => {
      report += `  ${player.name}${player.locked ? ' (LOCKED)' : ''}:\n`;
      report += `    Shots: ${player.stats.shots}\n`;
      report += `    Rebounds: ${player.stats.rebounds}\n`;
      report += `    Assists: ${player.stats.assists}\n`;
      report += `    Points: ${player.stats.points}\n`;
      report += `\n`;
    });
    report += `-------------------------\n`;
    report += `Generated on: ${new Date().toLocaleString()}\n`;
    return report;
  }


  // --- Event Listeners for Main Buttons ---
  // MODIFIED: Now increments stat for the active player
  document.getElementById('shots-btn').addEventListener('click', () => incrementPlayerStat('shots'));
  document.getElementById('rebounds-btn').addEventListener('click', () => incrementPlayerStat('rebounds'));
  document.getElementById('assists-btn').addEventListener('click', () => incrementPlayerStat('assists'));
  document.getElementById('points-btn').addEventListener('click', () => incrementPlayerStat('points'));
  document.getElementById('rival-score-button').addEventListener('click', incrementRivalPoints);

  document.getElementById('reset-game-btn').addEventListener('click', () => {
    showMessageBox(
      'Reset Game',
      'Are you sure you want to reset all scores and player stats?',
      'confirm',
      () => {
        myTeamScore = 0;
        rivalTeamScore = 0;
        players.forEach(player => {
          STAT_TYPES.forEach(stat => player.stats[stat] = 0);
        });
        activePlayerId = null; // MODIFIED: Reset active player on game reset
        activeStat = null;
        saveGameData();
        updateUI();
        showMessageBox('Game Reset', 'The game has been reset successfully!', 'alert');
      }
    );
  });

  // Register the Service Worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      // Ensure service worker is only registered if protocol is http or https
      if (location.protocol.startsWith('http')) {
        navigator.serviceWorker.register('./sw.js')
          .then(registration => {
            console.log('Service Worker registered: ', registration);
          })
          .catch(registrationError => {
            console.error('Service Worker registration failed: ', registrationError);
          });
      } else {
        console.warn('Service Worker not registered: Page must be served over HTTP or HTTPS.');
      }
    });
  }


  // Load data from local storage on window load
  window.addEventListener('load', loadGameData);
</script>